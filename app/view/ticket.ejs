<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiket Saya - TravelTrain</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5', // Indigo
                        secondary: '#EC4899', // Pink
                        dark: '#1e1b4b',
                    }
                }
            }
        }
    </script>

    <style>
        /* Animasi Fade In */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeInUp 0.6s ease-out forwards; }

        /* Background Pattern */
        body {
            background-color: #F8FAFC;
            background-image: radial-gradient(#E0E7FF 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        /* Glass Effect Navbar */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="text-gray-700 flex flex-col min-h-screen">

    <nav class="fixed w-full z-50 top-0 glass-panel shadow-sm">
        <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center gap-2 group transition hover:opacity-80">
                <div class="w-8 h-8 bg-gradient-to-tr from-primary to-secondary rounded-lg flex items-center justify-center text-white shadow-lg group-hover:-rotate-12 transition">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <span class="font-heading font-bold text-lg text-gray-800">Kembali</span>
            </a>
            <span class="font-heading font-bold text-xl text-primary">Riwayat Tiket</span>
        </div>
    </nav>

    <div class="flex-grow max-w-4xl mx-auto w-full px-6 pt-28 pb-20">
        
        <% if (pesanan.length === 0) { %>
            
            <div class="text-center py-20 bg-white/60 backdrop-blur-md rounded-3xl border border-white/50 shadow-xl animate-fade-in">
                <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-indigo-50 mb-6 relative">
                    <i class="fa-solid fa-ticket text-4xl text-primary absolute animate-bounce"></i>
                    <i class="fa-solid fa-ticket text-4xl text-secondary absolute opacity-30 blur-sm translate-y-2"></i>
                </div>
                <h3 class="font-heading text-2xl font-bold text-gray-800">Belum Ada Tiket</h3>
                <p class="text-gray-500 mt-2 mb-8">Kamu belum memesan perjalanan apapun.</p>
                <a href="/" class="bg-gradient-to-r from-primary to-secondary text-white font-bold py-3 px-8 rounded-full shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 transition transform hover:-translate-y-1">
                    Pesan Sekarang
                </a>
            </div>

        <% } else { %>
            
            <div class="space-y-8">
                <% pesanan.reverse().forEach((item, index) => { %>
                    <div class="relative w-full bg-white rounded-3xl shadow-xl shadow-indigo-100 overflow-hidden flex flex-col md:flex-row animate-fade-in border border-gray-100 group transition-all duration-300 hover:-translate-y-1" 
                         style="animation-delay: <%= index * 0.1 %>s;">
                        
                        <div class="<%= item.status === 'Lunas' ? 'bg-gradient-to-br from-primary to-secondary' : 'bg-gray-700' %> 
                                    p-6 md:w-24 md:flex-shrink-0 flex md:flex-col items-center justify-between md:justify-center gap-2 text-white relative overflow-hidden transition-colors duration-500">
                            <div class="absolute inset-0 bg-white opacity-10"></div>
                            <i class="fa-solid fa-train text-3xl rotate-0 md:-rotate-90"></i>
                            <span class="font-heading font-bold tracking-widest text-[10px] rotate-0 md:-rotate-90 whitespace-nowrap md:mt-4 uppercase">
                                <%= item.status === 'Lunas' ? 'Boarding Pass' : 'Invoice' %>
                            </span>
                        </div>

                        <div class="flex-grow p-6 md:p-8 flex flex-col justify-between relative">
                            
                            <div class="flex justify-between items-start mb-6 relative z-10">
                                <div>
                                    <% if (item.status === 'Lunas') { %>
                                        <span class="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-1 rounded-md border border-green-200 uppercase tracking-wide">
                                            <i class="fa-solid fa-check-circle mr-1"></i> Lunas
                                        </span>
                                    <% } else { %>
                                        <span class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded-md border border-yellow-200 uppercase tracking-wide animate-pulse">
                                            <i class="fa-regular fa-clock mr-1"></i> Menunggu Pembayaran
                                        </span>
                                    <% } %>

                                    <h2 class="font-heading text-2xl md:text-3xl font-extrabold text-gray-800 mt-2"><%= item.namaKereta %></h2>
                                    <p class="text-sm text-gray-400 font-medium">Kelas Eksekutif</p>
                                </div>
                                
                                <div class="text-right flex flex-col items-end">
                                    <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">Kode Booking</p>
                                    <p class="font-mono text-xl md:text-2xl font-bold text-primary tracking-widest mb-1"><%= item.kode %></p>
                                    
                                    <button onclick="batalkanPesanan('<%= item.kode %>')" 
                                            class="text-xs font-bold text-red-400 hover:text-red-600 border border-red-200 hover:border-red-400 bg-red-50 px-3 py-1 rounded-full transition flex items-center gap-1">
                                        <i class="fa-solid fa-trash"></i> Batalkan
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-3 gap-6 relative z-10 mb-4">
                                <div>
                                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Tanggal</p>
                                    <p class="font-semibold text-gray-800 text-lg">
                                        <i class="fa-regular fa-calendar text-secondary mr-1"></i>
                                        <%= item.tanggal %>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Jam</p>
                                    <p class="font-semibold text-gray-800 text-lg">
                                        <i class="fa-regular fa-clock text-primary mr-1"></i>
                                        <%= item.berangkat %> WIB
                                    </p>
                                </div>
                                <div class="col-span-2 md:col-span-1 border-t md:border-t-0 md:border-l border-dashed border-gray-200 pt-4 md:pt-0 md:pl-6">
                                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Total Harga</p>
                                    <p class="font-heading font-extrabold text-xl text-secondary"><%= item.harga %></p>
                                </div>
                            </div>

                            <% if (item.status !== 'Lunas') { %>
                                <div class="space-y-3">
                                    <p class="text-sm font-semibold text-gray-600 mb-3">Pilih Metode Pembayaran:</p>
                                    <div class="grid grid-cols-3 gap-3">
                                        <!-- Bank Transfer -->
                                        <button onclick="bayarSekarang('<%= item.kode %>', '<%= item.harga %>', 'bank')" 
                                                class="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transform hover:-translate-y-1 transition flex flex-col justify-center items-center gap-2">
                                            <i class="fa-solid fa-university text-lg"></i>
                                            <span class="text-xs hidden sm:inline">Bank Transfer</span>
                                            <span class="text-xs sm:hidden">Bank</span>
                                        </button>
                                        <!-- E-Wallet -->
                                        <button onclick="bayarSekarang('<%= item.kode %>', '<%= item.harga %>', 'ewallet')" 
                                                class="bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-3 rounded-xl shadow-lg transform hover:-translate-y-1 transition flex flex-col justify-center items-center gap-2">
                                            <i class="fa-solid fa-mobile-screen text-lg"></i>
                                            <span class="text-xs hidden sm:inline">E-Wallet</span>
                                            <span class="text-xs sm:hidden">E-Wallet</span>
                                        </button>
                                        <!-- QRIS -->
                                        <button onclick="bayarSekarang('<%= item.kode %>', '<%= item.harga %>', 'qris')" 
                                                class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 rounded-xl shadow-lg transform hover:-translate-y-1 transition flex flex-col justify-center items-center gap-2">
                                            <i class="fa-solid fa-qrcode text-lg"></i>
                                            <span class="text-xs hidden sm:inline">QRIS</span>
                                            <span class="text-xs sm:hidden">QRIS</span>
                                        </button>
                                    </div>
                                </div>
                            <% } %>
                        </div>

                        <div class="relative bg-gray-50 p-6 md:w-64 flex flex-col items-center justify-center border-t md:border-t-0 md:border-l-2 border-dashed border-gray-200 <%= item.status !== 'Lunas' ? 'opacity-50 grayscale' : '' %>">
                            <div class="absolute -top-3 md:top-auto md:-left-3 w-6 h-6 bg-[#F8FAFC] rounded-full shadow-inner"></div>
                            <div class="absolute -bottom-3 md:bottom-auto md:top-1/2 md:-mt-3 md:-left-3 w-6 h-6 bg-[#F8FAFC] rounded-full shadow-inner"></div>

                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 mb-3 group-hover:scale-105 transition duration-300">
                                <i class="fa-solid fa-qrcode text-6xl text-gray-800"></i>
                            </div>
                            <p class="text-[10px] text-center text-gray-400 font-medium">
                                <%= item.status === 'Lunas' ? 'Scan saat boarding' : 'Bayar untuk aktifkan' %>
                            </p>
                        </div>
                    </div>
                <% }) %>
            </div>
            
            <div class="mt-12 text-center animate-fade-in" style="animation-delay: 0.5s;">
                <a href="/" class="inline-flex items-center text-primary font-bold hover:text-secondary transition">
                    <i class="fa-solid fa-plus-circle mr-2"></i> Pesan Tiket Lain
                </a>
            </div>

        <% } %>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // FUNGSI 1: BAYAR
    function bayarSekarang(kode, harga, metode) {
        console.log("Tombol Bayar ditekan untuk:", kode, "Metode:", metode);

        let namaMetode = '';
        let deskripsi = '';
        
        if (metode === 'bank') {
            namaMetode = 'Bank Transfer';
            deskripsi = 'Transfer ke rekening yang sudah disiapkan. Kode transfer akan dikirim melalui email.';
        } else if (metode === 'ewallet') {
            namaMetode = 'E-Wallet';
            deskripsi = 'Bayar menggunakan OVO, GoPay, atau DANA. Proses pembayaran instan.';
        } else if (metode === 'qris') {
            namaMetode = 'QRIS';
            deskripsi = 'Scan kode QRIS menggunakan aplikasi bank atau e-wallet Anda.';
        }

        Swal.fire({
            title: 'Bayar Tiket?',
            html: `<div class="text-left">
                    <p class="mb-2"><strong>Total:</strong> ${harga}</p>
                    <p class="mb-2"><strong>Metode:</strong> ${namaMetode}</p>
                    <p class="text-sm text-gray-600">${deskripsi}</p>
                   </div>`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Lanjutkan Pembayaran',
            cancelButtonText: 'Batal',
            confirmButtonColor: '#4F46E5'
        }).then((result) => {
            if (result.isConfirmed) {
                // Loading...
                Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading() });

                // Kirim ke Server
                fetch('/pay-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kode: kode, metode: metode })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Lunas!', `Tiket berhasil dibayar via ${namaMetode}`, 'success')
                        .then(() => location.reload());
                    } else {
                        Swal.fire('Gagal', 'Terjadi kesalahan', 'error');
                    }
                })
                .catch(err => console.error("Error Bayar:", err));
            }
        });
    }

    // FUNGSI 2: BATALKAN
    function batalkanPesanan(kodeBooking) {
        // DEBUG: Pastikan fungsi ini jalan
        console.log("Tombol BATAL ditekan. Kode:", kodeBooking); 
        // alert("Cek Kode: " + kodeBooking); // Aktifkan kalau mau tes popup manual

        Swal.fire({
            title: 'Hapus Tiket?',
            text: "Yakin mau hapus tiket " + kodeBooking + "?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Gak Jadi'
        }).then((result) => {
            if (result.isConfirmed) {
                
                // Tampilkan Loading
                Swal.fire({
                    title: 'Menghapus...',
                    timer: 2000,
                    didOpen: () => Swal.showLoading()
                });

                // KIRIM REQUEST KE SERVER
                // Perhatikan URL '/cancel-order' harus sesuai dengan routes/index.js
                fetch('/cancel-order', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ kode: kodeBooking })
                })
                .then(response => {
                    console.log("Response Server:", response); // Cek Console
                    return response.json();
                })
                .then(data => {
                    console.log("Data diterima:", data); // Cek Console
                    if (data.status === 'success') {
                        Swal.fire('Terhapus!', 'Tiket sudah dibatalkan.', 'success')
                        .then(() => {
                            window.location.reload(); // Refresh Halaman
                        });
                    } else {
                        Swal.fire('Gagal!', 'Server menolak penghapusan.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error Fetch:', error);
                    Swal.fire('Error!', 'Gagal menghubungi server.', 'error');
                });
            }
        });
    }
</script>
</body>
</html>